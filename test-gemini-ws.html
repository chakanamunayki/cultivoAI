<!DOCTYPE html>
<html>
<head>
    <title>Gemini Live WebSocket Test</title>
</head>
<body>
    <h1>Gemini Live WebSocket Connection Test</h1>
    <button onclick="testConnection()">Test Connection</button>
    <pre id="log"></pre>

    <script>
        const API_KEY = "AIzaSyAQEcYJyq7nW3oOhcm8lcOkW1XpU9b7UQs";
        const WS_URL = `wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${API_KEY}`;

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toISOString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function testConnection() {
            document.getElementById('log').textContent = '';
            log('Starting WebSocket connection test...');

            const ws = new WebSocket(WS_URL);
            ws.binaryType = 'arraybuffer'; // Handle binary data properly

            ws.onopen = () => {
                log('âœ… WebSocket connected successfully');

                // Test with full configuration like the app
                const minimalSetup = {
                    setup: {
                        model: "models/gemini-2.0-flash-exp",
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: {
                                        voiceName: "Puck"
                                    }
                                }
                            }
                        },
                        systemInstruction: {
                            parts: [{ text: "You are a helpful assistant." }]
                        }
                    }
                };

                log('Sending minimal setup message:');
                log(JSON.stringify(minimalSetup, null, 2));
                ws.send(JSON.stringify(minimalSetup));
            };

            ws.onmessage = (event) => {
                log('ðŸ“¨ Received message:');
                try {
                    let text;
                    if (event.data instanceof ArrayBuffer) {
                        // Convert ArrayBuffer to string
                        text = new TextDecoder().decode(event.data);
                    } else if (event.data instanceof Blob) {
                        // This shouldn't happen with binaryType='arraybuffer', but handle it
                        log('Received Blob (unexpected)');
                        return;
                    } else {
                        text = event.data;
                    }

                    const data = JSON.parse(text);
                    log(JSON.stringify(data, null, 2));
                } catch (e) {
                    log('Parse error: ' + e.message);
                    log('Raw data type: ' + typeof event.data);
                }
            };

            ws.onerror = (event) => {
                log('âŒ WebSocket error: ' + JSON.stringify(event));
            };

            ws.onclose = (event) => {
                log(`ðŸ”´ WebSocket closed. Code: ${event.code}, Reason: "${event.reason}", Clean: ${event.wasClean}`);
            };
        }
    </script>
</body>
</html>
